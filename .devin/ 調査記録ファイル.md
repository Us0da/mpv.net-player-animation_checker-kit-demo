mpv player / mpv.net player を使ってアニメ、映画、動画などの映像コンテンツの作画、動画検査、テストショットのチェック環境を構築したいです。
.gif,.mp4,... 等の動画形式データ再生アプリケーション、プレイヤーを選定しています。

エディション  Windows 11 Home
バージョン  25H2
インストール日  2025/06/05 (木)
OS ビルド  26200.7019
エクスペリエンス  Windows 機能エクスペリエンス パック 1000.26100.265.0

### 他mpvの設定や挙動に影響を与えそうな項目
| 項目 | 詳細 | mpvでの影響 |
| :--- | :--- | :--- |
| プロセッサ | 12th Gen Intel(R) Core(TM) i7-12700 (12コア/20スレッド, 2.1 GHz) | デコード処理の速さに直結 複雑なコーデック（AV1とか）を再生する時、CPUパワーが活きる |
| RAM | 32 GB (CENTURY MICRO XMP2.0 CB16G-D4U3200 x2) | 一時的なバッファやキャッシュに利用される。メモリが少ないとカクつく原因になるけど、32GBあればOK |
| グラフィックスカード | NVIDIA GeForce RTX 3060 Ti (8 GB) | ハードウェアデコード (VA-API/NVDEC/DXVA2) の処理に使うのは非推奨。逆再生と相性が悪いので他で活用できるなら活用する |

取り扱う動画形式の優先順位は .mp4 > .gif > .WebM > .flv > etc…… の順で安定性や動作性を担保したいです。
.gif形式、短尺の.mp4形式を再生する際に、RAMキャッシュのような高速プレビュー（つまり読み込みと即時スクラブの快適さを最優先にするか）についてですが、フレーム単位での自然な再生、視聴体験を安定させる事が最重要事項になります。従って、読み込みや即時スクラブの快適さのプライオリティは非常に高いです。アナログでの作画チェック（指でパラパラめくり直し動きをチェックする）のように、ラフでタフで、ハイレスポンスな環境を求めています。
従って高画質化や、4K、シェーダー、高音質化やオーディオ性能の向上といった要素はプライオリティが低いです。音声に関してはもちろんアニメーションや映像作品において音とのタイミング合わせは重要なので、音質よりもしっかり音が鳴る事そのものを重視したいです。
色についても標準的に担保される設定であれば十分で、色空間や色彩表現に割くリソースより他の優先事項に割いてほしいです。
フレーム補完のような設定は絶対にオフになるように設定したいです。（厳密なチェックが阻害される。）気を付けて設定項目をチェックして下さい。画質向上のために重くなるような設定は全てオミットで問題ありません。

現在、既定で利用しているプレイヤーは Keyframe MP 2 になります。
https://zurbrigg.com/keyframe-mp-documentation
職業でアニメーションを制作しています。

1カットの作業の仕上がり確認をする際、windows11標準のメディアプレイヤーや標準的な動画プレイヤーでは、gifやmp4をシークバーでフレームを意識して移動するのに不便だったり、データ形式が対応しておらずチェックできない事があります。10分から30分ほどの動画では利便性に事欠かないものの、数十秒の作画をチェックしたり、より短尺な動画では扱いづらい事が多いです。映像制作、作画作業中、担当カット単体のチェックのため、5秒以内くらいの映像をカメラワーク、動き付け、プリヴィズ、ビデオコンテ、デモ撮影などのチェッカーとして動画プレイヤーを毎回立ち上げています。起動の速さも標準プレイヤーなどではストレスに感じることが多いです。
Keyframe MP はアニメーション制作時のサンプル再生やテスト再生に手軽に利用出来る点が魅力ですが、ライセンスの制約があり、無料版では起動時に必ずポップアップが表示されたり、多重起動を抑制され1つの動画しか再生できません。
pro版をライセンス料を支払って利用するよりも、カスタム性が高く新しいエンジンで、軽量、拡張性が高いプレーヤーやユーザースクリプトなどでカスタムできるベストなツールとして"mpv.net player"というソフトウェアに辿り着きました。
mpvプレイヤーは、その軽量な設計、FFmpegに基づく広範なコーデックサポート、そしてLuaスクリプトによる高いカスタム性により、プロフェッショナルなアニメーション検査環境の基盤として最適です。特に、KMP2で高く評価されている時間の概念よりも「フレーム」の概念を優先し、即座のフィードバックを実現するユーザーエクスペリエンス（UX）は、mpvのフレーム制御コマンドとカスタムOSD/OSC機能によって再現、拡張できると思います。

mpv.net player のカスタム設定をどのように調整するかですが、映像のフレームを最重要視したいと考えています。
画質向上フィルタやシェーダーを完全にオミット、レンダリング負荷を極限まで低減させる設定を採用します。
mpvの demuxer cacheは、動画データのパケットをRAM上に一時保存し、高速シークを可能にします。
短尺動画の高速プレビューを最優先するため、キャッシュサイズを大きく設定し、ファイルを完全にメモリ内に保持するように構成します。

| 設定項目                   | 推奨値（32GB RAM環境） | 目的と専門的解説                                                             |
| :--------------------- | :-------------- | :------------------------------------------------------------------- |
| cache                  | yes             | demuxer cacheを有効化し、高速シークをサポート。                                    |
| demuxer-max-bytes      | 4096MB            | 再生開始前のフォワードキャッシュサイズ。短尺GIFやMP4の瞬間的な読み込みと高速アクセスを実現。                    |
| demuxer-max-back-bytes | 4096MB            | バックワードキャッシュサイズ。即時スクラブ（コマ戻しを含む）の応答性と、逆再生の安定性を大幅に向上させる。              |
| demuxer-cache-wait     | yes             | 再生開始前にキャッシュが最大容量またはファイル終端に達するまで待機する。これにより、再生開始直後から即座にスクラブ操作が可能となる。 |
| force-seekable         | yes             | ストリームの種類に関わらず、常にシークを有効化し、キャッシュ内でのシーク成功率を高める。                       |
| demuxer-donate-buffer  | yes (デフォルト)     | 後方キャッシュが前方キャッシュの空き容量を利用できるようにし、逆方向スクラブの柔軟性を高める。                   |

GIFや一部のWebM形式は、厳密な固定フレームレート（CFR）ではなく、可変フレームレート（VFR）として扱われることがあります。アニメーション検査では、正確なフレームタイミングの確認が必須であり、VFRは不適格です。mpvのデフォルト設定はA/V同期を優先しますが、検査環境では再生速度をフレームレートに厳格に合わせる必要があります。A/V同期を優先する必要はありません。
高負荷なレンダリング処理を完全に無効化することで、システムの負荷を下げ、デコードとフレーム描画のタイミングを厳密に保つよう誘導します。また、GIFファイルのようにフレーム数が優先される形式に対しては、プロファイルを用いてキャッシュをさらに厚く設定し、デコードの遅延を物理的に排除することで、再生エンジンのフレーム表示タイミングの厳格化を支援します。

逆再生について不具合が報告されていますが、ハードウェアデコードは"hwdec=no"にして利用する他、実験的に試行錯誤を行いたいと考えています。
## Tips
  ・エラーが出たら: もし逆再生中に「reversal queue overflow (キューがあふれた)」みたいなエラーが出る場合 --video-reversal-buffer のサイズを増やしてみる。
  ・コマ戻しの精度: コマ戻し (frame-back-step) はシークモードを使うから、ファイル形式によっては100%正確じゃないかも。

KMP2の核心的なUXである「フレーム数/FPS優先」の表示を再現するため、標準OSDのカスタマイズと、拡張性の高いカスタムOSCスクリプトの導入を計画します。
最も手軽かつ効果的にフレーム情報を優先表示するには、mpvの標準機能であるosd-status-msgプロパティを利用します。これにより、画面下部に再生時間ではなく、フレーム数を基準とした情報を常に表示させます。

```
\# Frame number / Total frames (FPS: Current FPS) の形式で表示  
osd-status-msg\=Frame: ${estimated-frame-number} / ${estimated-frame-count} (FPS: ${container-fps})
```

さらに詳細な検査を可能にするため、詳細情報表示用のLuaスクリプトであるframe\_info.luaの導入が推奨されます。このスクリプトは、デコード情報やフレームステータスをオーバーレイで表示でき、portable\_config/scripts/ディレクトリに配置し、input.confでTABキーなどに割り当てることで利用可能になります。
KMP2のように「シークバーをマウスで直感的に動かせ、動画画面がバーの移動に連動して動く」UXを実現するためには、OSC（On Screen Controller）のカスタマイズが不可欠です。
シークバー自体を時間ベースのパーセンテージではなく、総フレーム数ベースで描画するには、既存のカスタムOSC（例：ModernXやModernZ 6）のLuaソースコードを深く改造する必要があります。
標準のOSCは、総時間（duration）と現在時刻（time-pos）に基づいてシークバーの位置を計算しています。この計算ロジックを、総フレーム数（estimated-frame-count）と現在フレーム番号（estimated-frame-number）に置き換える必要があります。
この改造は技術的に最も難易度が高く、数日間にわたるLua開発スキルを必要とします。既存のOSCのフレームワークを利用することでゼロからのコーディング労力は避けられますが、Luaスクリプトのプロパティ監視と描画関数の内部ロジックを理解することが前提となります。このカスタムは、検査環境の究極の目標ではありますが、まずは標準OSDとユーザースクリプトによる代替を導入し、その後の拡張として計画することが合理的です。

複数ウィンドウでの比較チェックにおける究極の目標は、片方のプレイヤーが操作された際に、もう片方のプレイヤーも同一のフレームに瞬時にシークする「フレーム同期」です。

現在のmpvのネイティブ機能にはフレーム同期機能は搭載されていません。これを実現するには、Luaスクリプトによる高度な拡張が必要です。具体的には、一方のプレイヤーが再生状態やフレーム番号のプロパティを監視し、その情報をプロセス間通信（IPC）を通じてもう一方のプレイヤーへ送信し、受け取ったプレイヤーがそのフレーム番号にシークするコマンドを実行するという複雑なロジックが必要です。この機能は設定ファイル調整の範疇を超え、専門的なカスタムLuaスクリプト開発（難易度：高）を必要としますが、将来的なワークフロー最適化の重要な拡張要素となります。

加えて、カスタマイズの要素が多岐にわたるmpv の OPTIONS ドキュメントには約440個のオプションが含まれており、非常に包括的なマニュアルとなっています。しかし、英語が苦手な自分には極めてハードルの高いマニュアルになっています。

## Notes

### 重要な注意点
1. **フレーム補完は絶対にオフ**: `interpolation=no`が明示的に設定されていることを確認してください。これがオンだと、元のフレームが改変され、正確な検査ができません。
2. **ハードウェアデコードの無効化**: 逆再生との互換性問題があるため、`hwdec=no`を必ず設定してください。CPUパワー（i7-12700）で十分カバーできます。
3. **キャッシュサイズの調整**: 32GB RAMを活かし、短尺動画を完全にメモリ内に保持します。より長い動画を扱う場合は、`demuxer-max-bytes`と`demuxer-max-back-bytes`をさらに増やすことができます。
4. **video-syncの選択**: `display-vdrop`は、ディスプレイのリフレッシュレートに同期しつつ、必要に応じてフレームをドロップします。ただし、`framedrop=no`と組み合わせることで、フレームドロップを最小限に抑えます。
5. **プロファイルの活用**: GIFファイル専用の設定を`[extension.gif]`プロファイルで定義することで、ファイル形式ごとに最適化できます。
6. **estimated-frame-numberの制限**: フレーム番号は推定値であり、VFR（可変フレームレート）動画では正確でない場合があります。しかし、CFR（固定フレームレート）の作画チェック用動画では十分に機能します。

この設定により、Keyframe MP 2のようなフレーム優先のワークフローを、より柔軟で拡張性の高いmpv環境で実現できます。
字幕の機能など、コンセプトに関係ない多くのオプションは不要なので、実装に関連する項目のみを的確にピックし、それらについての設定や推奨の値を出力して下さい。

https://github.com/mpv-player/mpv/wiki/Display-synchronization#display-synchronization-techniques
についてですが

添付ファイル（Display synchronization.md）を読むと、「display-sync」こそが最強で、フレーム落ちゼロの"完璧な再生"を実現する技術だって書いてある。
じゃあ、なんでそれを使わないか？
答えは、「僕くんのワークフローと相性が悪いから」なんだ。
  1. display-syncは「長回し」の再生（Playback）用
    display-syncが解決しようとしてるメインの問題は、「23.976Hzの映画」を「60HzのPCモニター」で再生した時に起こる、**ビミョーなカクつき（スタッター）**なんだよね。
    これを解決するために、display-syncはモニターの更新タイミング（vsync）を基準にして、映像がカクつかないように、なんと「音声」の速度をビミョーに（±1%とか）イジって調整するっていう、かなりアクロバティックなこと（display-resampleモード）をやってる。
2. アニメ検査（Scrubbing）には向かない
    でも、僕くんのやりたいことは「2時間の映画を滑らかに観る」ことじゃなくて、「5秒のGIFやMP4を、コマ送り（.）したり、逆再生（R）したり、シークバーでグリグリする」ことだよね。
    display-syncには、このワークフローにとって致命的な弱点があるんだ。
    不安定なファイルで自動的にオフになる display-syncは、タイムスタンプが変なファイルや、VFR（可変フレームレート）のコンテンツだと、自動的に無効になっちゃう。
    GIFはVFR扱いが多い 僕くんが使うmpv-keyframe-guide.md（ファイル3）にも書いてある通り、**GIF形式は「フレーム精度が不正確」（つまりVFR）**なものが多い。
    つまり、せっかくdisplay-syncをオンにしても、いざ作画チェックでGIFを読み込んだ瞬間に「あ、このファイルVFRだ。はいdisplay-syncオフね」って勝手に無効化されたら、まったく意味がないし、むしろ動作が不安定になる原因になっちゃう。

という指摘があります。

1.  **`video-sync=audio`**

      * **役割:** 同期のボスを「音声（Audio Clock）」に任せる。
      * **理由:** `display-sync`みたいに複雑なこと（音声の速度を変えるとか）をしない、一番シンプルで予測しやすいモードだから。ポーズ、コマ送り、シークみたいな「再生が止まってる」状態での操作に一番強い。

2.  **`hr-seek=yes`**

      * **役割:** 高精度シーク。
      * **理由:** これこそが\*\*「フレーム最重要視」の心臓部\*\*。`hr-seek`をオンにしないと、コマ送り（`.`）やシークバーのドラッグが、キーフレーム（映像の区切り）単位になっちゃって、正確な1フレーム移動ができない。`Keyframe MP 2`の操作感を再現するのに必須。

3.  **巨大なキャッシュ (`demuxer-max-bytes=4096MiB`とか)**

      * **役割:** ファイルを丸ごとメモリにぶち込む。
      * **理由:** `hr-seek`で正確な位置に飛ぼうとしても、データがPCのストレージ（SSDとか）にあると、読み込みで一瞬待たされる。特に「1コマ戻し（`,`）」はファイルの前方からデータを読み直すから超遅い。
      * でも、ファイルを丸ごとRAM（メモリ）にキャッシュしちゃえば、ストレージへのアクセスがゼロになる。`video-sync=audio`と`hr-seek=yes`と組み合わせることで、\*\*「押した瞬間に、正確なフレームに、ゼロ遅延で飛ぶ」\*\*っていう、理想の検査環境が完成するんだ。

という情報についても、ドキュメントの情報と比較し、どちらがよりよい環境を構築できるかを出力して下さい。

現在の調査状況を反映して、作成する予定の"mpv.conf"の内容を記述します。（一応mpv.netを利用しているので"mpvnet.conf"も記述します。）
前回までの会話を踏まえつつ、コンセプトとズレている点やおかしい設定や存在しない設定が記述されていないか、リポジトリと比較し、徹底的にチェックして下さい。

"~\mpv.net-v7.1.1.4-beta-portable-x64\portable_config\mpv.conf"

```conf
# == 基本描画 / パフォーマンス
vo=gpu                             # （Windows環境での標準）軽量で安定性が高く、カスタムシェーダーを無効化できます
gpu-api=<d3d11|vulkan>             # Windowsでの安定性とパフォーマンスのバランスが良い。d3d11,vulkanのどちらがいいかは環境差によるらしく、交互に切り替えて検証したい。

# == 再生・シークの応答性を優先したキャッシュ設定
cache=yes
demuxer-readahead-secs=120         # デマルチプレクサの先読み（秒）拡張
demuxer-max-bytes=4096MiB          # 前方4GBキャッシュ
demuxer-max-back-bytes=4096MiB     # 後方4GBキャッシュ（1コマ戻し高速化）
demuxer-donate-buffer=yes          # 逆方向スクラブの柔軟性を高めるため明示的に設定
demuxer-cache-wait=yes             # ファイル全体を先行キャッシュ（即時スクラブ用）
cache-on-disk=no                   # RAM上のキャッシュを優先するため、ディスクキャッシュは不使用
framedrop=no                       # アニメーション検査では、すべてのフレームを正確に表示する必要があります。フレームドロップは厳密なチェックを阻害します。

# == 高精度シーク（フレーム単位移動の正確性）
hr-seek=yes                        # フレーム単位の正確な移動
hr-seek-framedrop=no               # シーク時のフレームドロップ無効
seekbarkeyframes=no                # シークバーでキーフレーム無視
force-seekable=yes                 # 常にシークを有効化する

# === 軽量化・性能優先
profile=fast                       # 性能優先モード
priority=high                      # プロセス優先度を高に設定
interpolation=no                   # フレーム補間無効（明示的に無効化）
video-latency-hacks=no             # ビデオレイテンシを1〜2フレーム削減しますが、interpolationを破壊します。interpolationは使用しないため影響は少ないですが、デフォルトのまま(no)で問題ありません。
deband=no                          # 画質処理無効
dither-depth=no                    # ディザリング無効
# dither=no                        # ディザリング無効（軽量化）

# == 出力品質は最低限で良い（画質フィルタは切る）
correct-downscaling=no            # ダウンスケーリング補正無効
linear-downscaling=no             # 線形ダウンスケーリング無効
sigmoid-upscaling=no              # シグモイドアップスケーリング無効
scale=bilinear
cscale=bilinear
dscale=bilinear
# 高品質フィルタはオフにする

# ビデオフィルタチェーンの初期化（不要なフィルタをすべて排除）
vf=                               # ビデオフィルタなし

# === デコーディング最適化：低遅延化
hwdec=no                          # ソフトウェアデコード推奨 逆再生時にGPUメモリ不足やフレーム破損が発生する可能性があります。また、`--video-reversal-buffer`の計算にGPUメモリが含まれず、正確な制御ができません。

# デコーダスレッド数の最適化
vd-lavc-threads=1                 # デコーダのスレッド使用を最小限に抑え低遅延化 スレッド数 `1` は極端かも？低遅延を狙うのはわかるけど、CPU (i7-12700) は（12コア/20スレッド）スレッド `1` だと、複雑なコーデック（AV1とか）のデコードが逆に追いつかなくて、コマ落ち（`framedrop=no`にしてるから詰まる）の原因になるかも。`vd-lavc-threads=0` （`0`は自動検出。だいたいコア数と同じか+1になる）か、多めに `vd-lavc-threads=12` とか `vd-lavc-threads=16` にしといた方が、トータルのデコード性能は上がって安定するかもしれない。

# 低遅延のための実験的オプション（必要に応じて有効化）
# untimed=no                      # ベンチマーク用のオプション。通常のフレーム表示タイミングをスキップします。フレームタイミングを厳格に保つため、有効化しません。

# === 逆再生関連オプション
video-reversal-buffer=512MiB      # （デフォルトより大きく）高ビットレートの動画や大きなGOPを持つ動画では、デフォルト値では不足する可能性。
demuxer-backward-playback-step=60 # 逆再生時にdemuxerが後方シークする秒数

# === オーディオ設定
aid=auto                          # 音声は重要ですが、タイミング合わせのため自動選択で十分です。
audio-pitch-correction=yes        # 再生速度変更時も音程を維持
volume=100                        # 初期音量
volume-max=150                    # 最大音量

# == OSD / 表示
# osd-status-msg OSDステータスメッセージのフォーマット。フレーム数を優先表示するために使用します。
osd-status-msg=Frame: ${estimated-frame-number} / ${estimated-frame-count} (FPS: ${container-fps})

osd-level=1                       # OSD表示レベル（0-3 1=シーク時のみ）
osd-duration=2000                 # OSD表示時間（ミリ秒）
osd-font-size=32                  # OSDフォントサイズ

# === 複数ウィンドウ起動 
process-instance=multi             # 常に新規ウィンドウで起動
ontop=no                           # 常に最前面表示はしない
# ウィンドウ位置を指定する場合（mpv.conf）（比較再生用）
geometry=50%:50%+0+0        # 左上
# geometry=50%:50%+960+0    # 右上（1920x1080画面の場合）

# == 再生動作
loop=no                # GUI側でループを管理することを推奨
keep-open=yes          # 再生終了でアプリが閉じるのを抑止（mpvのみでの挙動）
# mpv.net 側の設定でも類似の挙動コントロールあり

# == 同期設定
video-sync=audio                  # 音声同期モード 

# ファイル優先順などは mpv.net が担うためここでは省略

# `display-sync`系（`display-vdrop`も含む）は、滑らかさのために**フレームを犠牲にする（ドロップする）**ことがある。`display-sync`はVFR(GIF)と相性悪いし検査に向かない。「アニメーション検査ワークフローでの**フレーム精度**と**逆再生**」のためには、**`video-sync=display-vdrop` よりも `video-sync=audio` の方が圧倒的に望ましい**。

# ===== GIF専用プロファイル
[extension.gif] 
demuxer-max-bytes=4096MiB 
demuxer-max-back-bytes=4096MiB 
loop-file=inf

```

"~\mpv.net-v7.1.1.4-beta-portable-x64\portable_config\mpvnet.conf"

```conf
# mpv.net固有の設定ファイル

# UIを日本語化
language=japanese

# 常に新しいウィンドウで開く
process-instance=multi

# 終了時のウィンドウ位置を記憶
remember-window-position=yes

# 終了時の音量とミュート状態を記憶
remember-volume=yes

# 終了時のウィンドウの高さを記憶（アニメーションチェックでは幅より高さを固定したいことが多いため）
start-size=height-always

# 最近開いたファイルの履歴を30件に増やす（デフォルト: 15）
recent-count=30
```

この記述で設定フォルダを作る場合、存在しない設定などの記述が混じっていないかレポジトリと徹底的に比較し、解説などを出力して下さい。
出力はなるべく日本語で出力して下さい。
