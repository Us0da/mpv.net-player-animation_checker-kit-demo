# アニメーション制作特化：短尺動画の即時スクラブと軽量動作を最優先

# == 基本描画 / パフォーマンス
vo=gpu                             # （Windows環境での標準）軽量で安定性が高く、カスタムシェーダーを無効化できます
gpu-api=<d3d11|vulkan>             # Windowsでの安定性とパフォーマンスのバランスが良い。d3d11,vulkanのどちらがいいかは環境差によるらしく、交互に切り替えて検証したい。

# == 再生・シークの応答性を優先したキャッシュ設定
cache=yes
demuxer-readahead-secs=120         # デマルチプレクサの先読み（秒）拡張
demuxer-max-bytes=4096MiB          # 前方4GBキャッシュ
demuxer-max-back-bytes=4096MiB     # 後方4GBキャッシュ（1コマ戻し高速化）
demuxer-donate-buffer=yes          # 逆方向スクラブの柔軟性を高めるため明示的に設定
demuxer-cache-wait=yes             # ファイル全体を先行キャッシュ（即時スクラブ用）
cache-on-disk=no                   # RAM上のキャッシュを優先するため、ディスクキャッシュは不使用
framedrop=no                       # アニメーション検査では、すべてのフレームを正確に表示する必要があります。フレームドロップは厳密なチェックを阻害します。

# == 高精度シーク（フレーム単位移動の正確性）
hr-seek=yes                        # フレーム単位の正確な移動
hr-seek-framedrop=no               # シーク時のフレームドロップ無効
seekbarkeyframes=no                # シークバーでキーフレーム無視
force-seekable=yes                 # 常にシークを有効化する

# === 軽量化・性能優先
profile=fast                       # 性能優先モード
priority=high                      # プロセス優先度を高に設定
interpolation=no                   # フレーム補間無効（明示的に無効化）
video-latency-hacks=no             # ビデオレイテンシを1〜2フレーム削減しますが、interpolationを破壊します。interpolationは使用しないため影響は少ないですが、デフォルトのまま(no)で問題ありません。
deband=no                          # 画質処理無効
dither-depth=no                    # ディザリング無効
# dither=no                        # ディザリング無効（軽量化）

# == 出力品質は最低限で良い（画質フィルタは切る）
correct-downscaling=no            # ダウンスケーリング補正無効
linear-downscaling=no             # 線形ダウンスケーリング無効
sigmoid-upscaling=no              # シグモイドアップスケーリング無効
scale=bilinear
cscale=bilinear
dscale=bilinear
# 高品質フィルタはオフにする

# ビデオフィルタチェーンの初期化（不要なフィルタをすべて排除）
vf=                               # ビデオフィルタなし

# === デコーディング最適化：低遅延化
hwdec=no                          # ソフトウェアデコード推奨 逆再生時にGPUメモリ不足やフレーム破損が発生する可能性があります。また、`--video-reversal-buffer`の計算にGPUメモリが含まれず、正確な制御ができません。

# デコーダスレッド数の最適化
vd-lavc-threads=1                 # デコーダのスレッド使用を最小限に抑え低遅延化 スレッド数 `1` は極端かも？低遅延を狙うのはわかるけど、CPU (i7-12700) は（12コア/20スレッド）スレッド `1` だと、複雑なコーデック（AV1とか）のデコードが逆に追いつかなくて、コマ落ち（`framedrop=no`にしてるから詰まる）の原因になるかも。`vd-lavc-threads=0` （`0`は自動検出。だいたいコア数と同じか+1になる）か、多めに `vd-lavc-threads=12` とか `vd-lavc-threads=16` にしといた方が、トータルのデコード性能は上がって安定するかもしれない。

# 低遅延のための実験的オプション（必要に応じて有効化）
# untimed=no                      # ベンチマーク用のオプション。通常のフレーム表示タイミングをスキップします。フレームタイミングを厳格に保つため、有効化しません。

# === 逆再生関連オプション
video-reversal-buffer=512MiB      # （デフォルトより大きく）高ビットレートの動画や大きなGOPを持つ動画では、デフォルト値では不足する可能性。
demuxer-backward-playback-step=60 # 逆再生時にdemuxerが後方シークする秒数

# === オーディオ設定
aid=auto                          # 音声は重要ですが、タイミング合わせのため自動選択で十分です。
audio-pitch-correction=yes        # 再生速度変更時も音程を維持
volume=100                        # 初期音量
volume-max=150                    # 最大音量

# == OSD / 表示
# osd-status-msg OSDステータスメッセージのフォーマット。フレーム数を優先表示するために使用します。
osd-status-msg=Frame: ${estimated-frame-number} / ${estimated-frame-count} (FPS: ${container-fps})

osd-level=1                       # OSD表示レベル（0-3 1=シーク時のみ）
osd-duration=2000                 # OSD表示時間（ミリ秒）
osd-font-size=32                  # OSDフォントサイズ

# === 複数ウィンドウ起動 
process-instance=multi             # 常に新規ウィンドウで起動
ontop=no                           # 常に最前面表示はしない
# ウィンドウ位置を指定する場合（mpv.conf）（比較再生用）
geometry=50%:50%+0+0        # 左上
# geometry=50%:50%+960+0    # 右上（1920x1080画面の場合）

# == 再生動作
loop=no                # GUI側でループを管理することを推奨
keep-open=yes          # 再生終了でアプリが閉じるのを抑止（mpvのみでの挙動）
# mpv.net 側の設定でも類似の挙動コントロールあり

# == 同期設定
video-sync=audio                  # 音声同期モード 

# ファイル優先順などは mpv.net が担うためここでは省略

# `display-sync`系（`display-vdrop`も含む）は、滑らかさのために**フレームを犠牲にする（ドロップする）**ことがある。`display-sync`はVFR(GIF)と相性悪いし検査に向かない。「アニメーション検査ワークフローでの**フレーム精度**と**逆再生**」のためには、**`video-sync=display-vdrop` よりも `video-sync=audio` の方が圧倒的に望ましい**。

# ===== GIF専用プロファイル
[extension.gif] 
demuxer-max-bytes=4096MiB 
demuxer-max-back-bytes=4096MiB 
loop-file=inf

# 常に新規ウィンドウで起動（多重起動を無制限に許可）
# この設定により、Shiftキーなしで常に新しいウィンドウが開きます
process-instance=multi

# ===== マウススクラブを有効にするための重要設定 =====
no-window-dragging                # ウィンドウドラッグを無効化（マウスドラッグでのシークを有効にするため必須）

# ログレベル設定（スクリプトのトラブルシューティング用）
# 動作確認後は無効化してOK
msg-level=all=v                  # 詳細ログを有効化（スクリプトが読み込まれているか確認できる）